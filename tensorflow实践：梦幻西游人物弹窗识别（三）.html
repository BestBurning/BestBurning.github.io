<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="正走在通向编程、艺术、摄影、剪辑、写作、运动的路上的Full Stacker,Stay Cool!!!"><meta name="google-site-verification" content="q2XooBg_4_mx5-YvLlJvWzU3gxn_9nUvFpLz2_pU584"><meta name="keywords" content="tensorflow,梦幻西游,弹窗识别,python,自动点击,图像识别,卷积神经网络"><title>tensorflow实践：梦幻西游人物弹窗识别（三） - 第一帅</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-163115360-1','auto');ga('send','pageview');
</script><script>(function () {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">tensorflow实践：梦幻西游人物弹窗识别（三）</h1><a id="logo" href="/.">第一帅</a><p class="description">Shea的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/products/"><i class="fa fa-cubes"> 作品</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">tensorflow实践：梦幻西游人物弹窗识别（三）</h1><div class="post-meta">2020-03-20<span> | </span><span class="category"><a href="/categories/technology/">technology</a><span>  </span></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="tensorflow实践：梦幻西游人物弹窗识别（三）.html" href="/tensorflow实践：梦幻西游人物弹窗识别（三）.html#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境描述"><span class="toc-number">1.</span> <span class="toc-text">环境描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#明确问题"><span class="toc-number">2.</span> <span class="toc-text">明确问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#训练集准备"><span class="toc-number">3.</span> <span class="toc-text">训练集准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模型训练"><span class="toc-number">4.</span> <span class="toc-text">模型训练</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#进行统计"><span class="toc-number">4.1.</span> <span class="toc-text">进行统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建数据生成器"><span class="toc-number">4.2.</span> <span class="toc-text">构建数据生成器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模型编译统计"><span class="toc-number">4.3.</span> <span class="toc-text">模型编译统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开始训练"><span class="toc-number">4.4.</span> <span class="toc-text">开始训练</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模型保存"><span class="toc-number">4.5.</span> <span class="toc-text">模型保存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果"><span class="toc-number">4.6.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模型读取"><span class="toc-number">5.</span> <span class="toc-text">模型读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#进行预测"><span class="toc-number">6.</span> <span class="toc-text">进行预测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回顾"><span class="toc-number">7.</span> <span class="toc-text">回顾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#声明"><span class="toc-number">8.</span> <span class="toc-text">声明</span></a></li></ol></div></div><div class="post-content"><p>终于来到了预测的时候了，我们将按以下思路进行<br><img src="http://images.di1shuai.com/FpEUuMIj7eUHPEXYd4RNLpgy0l7Y" alt></p>
<p>本篇将围绕<strong>训练集准备、模型训练、保存、读取、预测</strong>讲述<a href="https://github.com/BestBurning/mhxy/blob/master/data_model.py" target="_blank" rel="noopener">data_model.py</a>代码</p>
<h3 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h3><p><a href="https://www.microsoft.com/zh-cn/software-download/windows10" target="_blank" rel="noopener">Windows</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">C:\Users\SF&gt;ver</span></span><br><span class="line"><span class="string">Microsoft</span> <span class="string">Windows</span> <span class="string">[版本</span> <span class="number">10.0</span><span class="number">.18363</span><span class="number">.720</span><span class="string">]</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.python.org/downloads/" target="_blank" rel="noopener">Python</a></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">C</span>:\<span class="selector-tag">Users</span>\<span class="selector-tag">SF</span>&gt;<span class="selector-tag">python</span> <span class="selector-tag">--version</span></span><br><span class="line"><span class="selector-tag">Python</span> 3<span class="selector-class">.7</span><span class="selector-class">.6</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.tensorflow.org/install" target="_blank" rel="noopener">Tensorflow</a></p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">C:\Users\SF&gt;python</span><br><span class="line">Python <span class="number">3.7</span><span class="number">.6</span> (tags/v3<span class="number">.7</span><span class="number">.6</span>:<span class="number">43364</span>a7ae0, Dec <span class="number">19</span> <span class="number">2019</span>, <span class="number">00</span>:<span class="number">42</span>:<span class="number">30</span>) [MSC v<span class="number">.1916</span> <span class="number">64</span> bit (AMD64)] <span class="keyword">on</span> win32</span><br><span class="line"><span class="built_in">Type</span> <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-19</span> <span class="number">23</span>:<span class="number">42</span>:<span class="number">50.170828</span>: I tensorflow/stream_executor/platform/<span class="keyword">default</span>/dso_loader.cc:<span class="number">44</span>] Successfully opened <span class="built_in">dynamic</span> <span class="keyword">library</span> cudart64_101.dll</span><br><span class="line">&gt;&gt;&gt; tf.__version__</span><br><span class="line"><span class="string">'2.1.0'</span></span><br></pre></td></tr></table></figure>

<p><a href="https://developer.nvidia.com/cuda-downloads" target="_blank" rel="noopener">CUDA</a></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">C</span>:\<span class="selector-tag">Users</span>\<span class="selector-tag">SF</span>&gt;<span class="selector-tag">nvcc</span> <span class="selector-tag">--version</span></span><br><span class="line"><span class="selector-tag">nvcc</span>: <span class="selector-tag">NVIDIA</span> (<span class="selector-tag">R</span>) <span class="selector-tag">Cuda</span> <span class="selector-tag">compiler</span> <span class="selector-tag">driver</span></span><br><span class="line"><span class="selector-tag">Copyright</span> (<span class="selector-tag">c</span>) 2005<span class="selector-tag">-2019</span> <span class="selector-tag">NVIDIA</span> <span class="selector-tag">Corporation</span></span><br><span class="line"><span class="selector-tag">Built</span> <span class="selector-tag">on</span> <span class="selector-tag">Wed_Oct_23_19</span><span class="selector-pseudo">:32</span><span class="selector-pseudo">:27_Pacific_Daylight_Time_2019</span></span><br><span class="line"><span class="selector-tag">Cuda</span> <span class="selector-tag">compilation</span> <span class="selector-tag">tools</span>, <span class="selector-tag">release</span> 10<span class="selector-class">.2</span>, <span class="selector-tag">V10</span><span class="selector-class">.2</span><span class="selector-class">.89</span></span><br></pre></td></tr></table></figure>

<p><a href="https://developer.nvidia.com/cudnn" target="_blank" rel="noopener">cuDNN</a></p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">C:</span>\tools\cuda\include\cudnn.h</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CUDNN_MAJOR 7</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CUDNN_MINOR 6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CUDNN_PATCHLEVEL 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CUDNN_VERSION (CUDNN_MAJOR * 1000 + CUDNN_MINOR * 100 + CUDNN_PATCHLEVEL)</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><a href="http://xyq.163.com/download/index.html?=xyqload" target="_blank" rel="noopener">梦幻西游</a></p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">启动方式   多标签版</span><br><span class="line">分辨率     <span class="number">800x600</span></span><br><span class="line">界面风格   暖风</span><br></pre></td></tr></table></figure>

<p><img src="http://images.di1shuai.com/FkW3mC0_6XGmeMxLdvqkxMGfcORg" alt><br><img src="http://images.di1shuai.com/FtjEhCyk52bg347Wsn0hAre_GiZL" alt></p>
<h3 id="明确问题"><a href="#明确问题" class="headerlink" title="明确问题"></a>明确问题</h3><p>在所有的事情开始之前，我们首先应该<strong>明确</strong>我们要处理一个怎样的<strong>问题</strong>：<br><strong>前、后左右</strong>的朝向识别朝<strong>前</strong>的<br><img src="http://images.di1shuai.com/FtyqTsE6LkqznePhEKYi_7nXlYGq" alt></p>
<p>也就是说只有<strong>两种</strong>分类 ： <strong>前</strong> 和 <strong>其他</strong><br>于是我们开始处理一个<strong>二分类</strong>问题：<strong>front</strong>、<strong>others</strong><br>所以我们准备构建一个<strong>卷积神经网络</strong></p>
<h3 id="训练集准备"><a href="#训练集准备" class="headerlink" title="训练集准备"></a>训练集准备</h3><p>原始图库我用的是<a href="http://www.6m5m.com/service-sid-6066.html" target="_blank" rel="noopener">15年的梦幻素材</a>，然后将他们过滤，背景加色，丢弃A通道，格式由<code>tga</code>转换为<code>jpeg</code>以后，按照<strong>front</strong>和<strong>others</strong>分类在两个文件夹，于是有了我们的<strong>训练集</strong></p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- data</span></span><br><span class="line">  	  <span class="string">|- train</span></span><br><span class="line">		   <span class="string">|-front</span></span><br><span class="line">			   <span class="string">|- xxx.jpg</span></span><br><span class="line">			   <span class="string">|- ...</span></span><br><span class="line">		   <span class="string">|-others</span></span><br><span class="line">			   <span class="string">|- xxx.jpg</span></span><br><span class="line">			   <span class="string">|- ...</span></span><br></pre></td></tr></table></figure>

<p><img src="http://images.di1shuai.com/Flq0Dx7IluKUI3AWy7rKXqb1K0Vq" alt></p>
<p>验证集是我在日常跑镖中积累的一丢丢图，勉强用作<strong>验证集</strong></p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- data</span></span><br><span class="line">  	  <span class="string">|- validation</span></span><br><span class="line">		   <span class="string">|-front</span></span><br><span class="line">			   <span class="string">|- xxx.jpg</span></span><br><span class="line">			   <span class="string">|- ...</span></span><br><span class="line">		   <span class="string">|-others</span></span><br><span class="line">			   <span class="string">|- xxx.jpg</span></span><br><span class="line">			   <span class="string">|- ...</span></span><br></pre></td></tr></table></figure>

<p><img src="http://images.di1shuai.com/FpME3kGg4QQDJr1VH4EVc69wu06V" alt></p>
<p>以上图集<strong>开源</strong>在<a href="https://github.com/BestBurning/mhxy/releases" target="_blank" rel="noopener">Github</a>上，你可以<strong>直接使用</strong>它来作为你的训练集和测试集</p>
<h3 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h3><h4 id="进行统计"><a href="#进行统计" class="headerlink" title="进行统计"></a>进行统计</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sumNum</span><span class="params">(dir_path)</span>:</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> lb <span class="keyword">in</span> os.listdir(dir_path):</span><br><span class="line">        <span class="keyword">for</span> im_name <span class="keyword">in</span> os.listdir(os.path.join(dir_path,lb)):</span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">()</span>:</span></span><br><span class="line">    t(<span class="string">'统计'</span>)</span><br><span class="line">    <span class="keyword">global</span> total_train, total_val, epochs</span><br><span class="line">    total_train = sumNum(c.train_dir)</span><br><span class="line">    total_val = sumNum(c.validation_dir)</span><br><span class="line">    epochs = math.ceil(total_train/batch_size)</span><br><span class="line">    print(<span class="string">'训练集标签 :'</span>,os.listdir(c.train_dir))</span><br><span class="line">    print(<span class="string">'训练集图片个数 :'</span> , total_train)</span><br><span class="line">    print(<span class="string">"验证集个数 :"</span>, total_val)</span><br><span class="line">    print(<span class="string">f'每批次训练个数: <span class="subst">&#123;batch_size&#125;</span>, 共进行 <span class="subst">&#123;epochs&#125;</span> 轮训练'</span>)</span><br><span class="line">    <span class="keyword">if</span> total_train == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'样本为0 无法训练'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line"><span class="comment">--------   统计    ----------</span></span><br><span class="line"></span><br><span class="line">训练集标签 : ['<span class="type">front</span>', <span class="symbol">'others</span>']</span><br><span class="line">训练集图片个数 : 5570</span><br><span class="line">验证集个数 : 128</span><br><span class="line">每批次训练个数: <span class="number">128</span>, 共要进行 <span class="number">44</span> 轮训练</span><br></pre></td></tr></table></figure>

<h4 id="构建数据生成器"><a href="#构建数据生成器" class="headerlink" title="构建数据生成器"></a>构建数据生成器</h4><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">def data_generator():</span><br><span class="line">    t(<span class="string">'数据生成器'</span>)</span><br><span class="line">    global train_data_gen,val_data_gen</span><br><span class="line"></span><br><span class="line">    train_image_generator = ImageDataGenerator(<span class="attribute">rescale</span>=1./255) # Generator <span class="keyword">for</span> our training data</span><br><span class="line">    validation_image_generator = ImageDataGenerator(<span class="attribute">rescale</span>=1./255) # Generator <span class="keyword">for</span> our validation data</span><br><span class="line"></span><br><span class="line">    train_data_gen = train_image_generator.flow_from_directory(<span class="attribute">batch_size</span>=batch_size,</span><br><span class="line">                                                           <span class="attribute">directory</span>=c.train_dir,</span><br><span class="line">                                                           <span class="attribute">shuffle</span>=<span class="literal">True</span>,</span><br><span class="line">                                                           target_size=(IMG_HEIGHT, IMG_WIDTH),</span><br><span class="line">                                                           <span class="attribute">class_mode</span>=<span class="string">'binary'</span>)</span><br><span class="line">    val_data_gen = validation_image_generator.flow_from_directory(<span class="attribute">batch_size</span>=batch_size,</span><br><span class="line">                                                              <span class="attribute">directory</span>=c.validation_dir,</span><br><span class="line">                                                              target_size=(IMG_HEIGHT, IMG_WIDTH),</span><br><span class="line">                                                              <span class="attribute">class_mode</span>=<span class="string">'binary'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">--------   数据生成器    ----------</span><br><span class="line"></span><br><span class="line">Found <span class="number">5570</span> images belonging to <span class="number">2</span> classes.</span><br><span class="line">Found <span class="number">128</span> images belonging to <span class="number">2</span> classes.</span><br></pre></td></tr></table></figure>

<h4 id="模型编译统计"><a href="#模型编译统计" class="headerlink" title="模型编译统计"></a>模型编译统计</h4><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">def model_summary():</span><br><span class="line">    t(<span class="string">'模型编译统计'</span>)</span><br><span class="line">    global model </span><br><span class="line">    model = Sequential([</span><br><span class="line">        Conv2D(16, (3,3), <span class="attribute">padding</span>=<span class="string">'same'</span>, <span class="attribute">activation</span>=<span class="string">'relu'</span>, input_shape=(IMG_HEIGHT, IMG_WIDTH ,3)),</span><br><span class="line">        MaxPooling2D((2, 2)),</span><br><span class="line">        Conv2D(32, (3,3), <span class="attribute">padding</span>=<span class="string">'same'</span>, <span class="attribute">activation</span>=<span class="string">'relu'</span>),</span><br><span class="line">        MaxPooling2D((2, 2)),</span><br><span class="line">        Conv2D(64, (3,3), <span class="attribute">padding</span>=<span class="string">'same'</span>, <span class="attribute">activation</span>=<span class="string">'relu'</span>),</span><br><span class="line">        MaxPooling2D(),</span><br><span class="line">        Flatten(),</span><br><span class="line">        Dense(64, <span class="attribute">activation</span>=<span class="string">'relu'</span>),</span><br><span class="line">        Dense(1)</span><br><span class="line">    ])</span><br><span class="line">    model.compile(<span class="attribute">optimizer</span>=<span class="string">'adam'</span>,</span><br><span class="line">              <span class="attribute">loss</span>=tf.keras.losses.BinaryCrossentropy(from_logits=True),</span><br><span class="line">              metrics=[<span class="string">'accuracy'</span>])</span><br><span class="line">    model.summary()</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">--------   模型编译统计    ----------</span><br><span class="line"></span><br><span class="line">2020-03-20 18:40:39.575508: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library nvcuda.dll</span><br><span class="line">2020-03-20 18:40:39.647045: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1555] Found device 0 with properties: </span><br><span class="line">pciBusID: 0000:03:00.0 name: GeForce GTX 1060 5GB computeCapability: 6.1</span><br><span class="line">coreClock: 1.7335GHz coreCount: 10 deviceMemorySize: 5.00GiB deviceMemoryBandwidth: 149.16GiB/s</span><br><span class="line">2020-03-20 18:40:39.648857: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudart64_101.dll</span><br><span class="line">2020-03-20 18:40:39.710717: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cublas64_10.dll</span><br><span class="line">2020-03-20 18:40:39.770435: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cufft64_10.dll</span><br><span class="line">2020-03-20 18:40:39.786318: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library curand64_10.dll</span><br><span class="line">2020-03-20 18:40:39.840028: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusolver64_10.dll</span><br><span class="line">2020-03-20 18:40:39.871203: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusparse64_10.dll</span><br><span class="line">2020-03-20 18:40:39.980945: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudnn64_7.dll</span><br><span class="line">2020-03-20 18:40:39.983037: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1697] Adding visible gpu devices: 0</span><br><span class="line">2020-03-20 18:40:39.989541: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1555] Found device 0 with properties: </span><br><span class="line">pciBusID: 0000:03:00.0 name: GeForce GTX 1060 5GB computeCapability: 6.1</span><br><span class="line">coreClock: 1.7335GHz coreCount: 10 deviceMemorySize: 5.00GiB deviceMemoryBandwidth: 149.16GiB/s</span><br><span class="line">2020-03-20 18:40:39.990720: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudart64_101.dll</span><br><span class="line">2020-03-20 18:40:39.991293: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cublas64_10.dll</span><br><span class="line">2020-03-20 18:40:39.991914: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cufft64_10.dll</span><br><span class="line">2020-03-20 18:40:39.992447: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library curand64_10.dll</span><br><span class="line">2020-03-20 18:40:39.993014: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusolver64_10.dll</span><br><span class="line">2020-03-20 18:40:39.993495: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusparse64_10.dll</span><br><span class="line">2020-03-20 18:40:39.994060: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudnn64_7.dll</span><br><span class="line">2020-03-20 18:40:39.996657: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1697] Adding visible gpu devices: 0</span><br><span class="line">2020-03-20 18:40:42.996316: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1096] Device interconnect StreamExecutor with strength 1 edge matrix:</span><br><span class="line">2020-03-20 18:40:42.996882: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1102]      0 </span><br><span class="line">2020-03-20 18:40:42.997242: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1115] 0:   N </span><br><span class="line">2020-03-20 18:40:43.003355: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1241] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3833 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1060 5GB, pci bus id: 0000:03:00.0, compute capability: 6.1)</span><br><span class="line">Model: "sequential"</span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">Layer (type)                 Output Shape              Param #   </span><br><span class="line">=================================================================</span><br><span class="line">conv2d (Conv2D)              (None, 100, 100, 16)      448       </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">max_pooling2d (MaxPooling2D) (None, 50, 50, 16)        0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">conv2d_1 (Conv2D)            (None, 50, 50, 32)        4640      </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">max<span class="emphasis">_pooling2d_</span>1 (MaxPooling2 (None, 25, 25, 32)        0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">conv2d_2 (Conv2D)            (None, 25, 25, 64)        18496     </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">max<span class="emphasis">_pooling2d_</span>2 (MaxPooling2 (None, 12, 12, 64)        0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">flatten (Flatten)            (None, 9216)              0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">dense (Dense)                (None, 64)                589888    </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">dense_1 (Dense)              (None, 1)                 65        </span><br><span class="line">=================================================================</span><br><span class="line">Total params: 613,537</span><br><span class="line">Trainable params: 613,537</span><br><span class="line">Non-trainable params: 0</span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br></pre></td></tr></table></figure>

<h4 id="开始训练"><a href="#开始训练" class="headerlink" title="开始训练"></a>开始训练</h4><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">def model_fit():</span><br><span class="line">    t(<span class="string">'开始训练'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> model,epochs,train_data_gen,total_train,batch_size,val_data_gen,total_val</span><br><span class="line"></span><br><span class="line">    <span class="keyword">history</span> = model.fit_generator(</span><br><span class="line">        train_data_gen,</span><br><span class="line">        steps_per_epoch=total_train // batch_size,</span><br><span class="line">        epochs=epochs,</span><br><span class="line">        validation_data=val_data_gen,</span><br><span class="line">        validation_steps=total_val // batch_size</span><br><span class="line">    )</span><br><span class="line">    acc = <span class="keyword">history</span>.<span class="keyword">history</span>[<span class="string">'accuracy'</span>]</span><br><span class="line">    val_acc = <span class="keyword">history</span>.<span class="keyword">history</span>[<span class="string">'val_accuracy'</span>]</span><br><span class="line"></span><br><span class="line">    loss=<span class="keyword">history</span>.<span class="keyword">history</span>[<span class="string">'loss'</span>]</span><br><span class="line">    val_loss=<span class="keyword">history</span>.<span class="keyword">history</span>[<span class="string">'val_loss'</span>]</span><br><span class="line"></span><br><span class="line">    epochs_range = <span class="built_in">range</span>(epochs)</span><br><span class="line"></span><br><span class="line">    plt.figure(figsize=(<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line">    plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    plt.plot(epochs_range, acc, label=<span class="string">'Training Accuracy'</span>)</span><br><span class="line">    plt.plot(epochs_range, val_acc, label=<span class="string">'Validation Accuracy'</span>)</span><br><span class="line">    plt.legend(<span class="keyword">loc</span>=<span class="string">'lower right'</span>)</span><br><span class="line">    plt.title(<span class="string">'Training and Validation Accuracy'</span>)</span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    plt.plot(epochs_range, loss, label=<span class="string">'Training Loss'</span>)</span><br><span class="line">    plt.plot(epochs_range, val_loss, label=<span class="string">'Validation Loss'</span>)</span><br><span class="line">    plt.legend(<span class="keyword">loc</span>=<span class="string">'upper right'</span>)</span><br><span class="line">    plt.title(<span class="string">'Training and Validation Loss'</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>

<h4 id="模型保存"><a href="#模型保存" class="headerlink" title="模型保存"></a>模型保存</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model_save</span><span class="params">()</span>:</span></span><br><span class="line">    t(<span class="string">'模型保存'</span>)</span><br><span class="line">    <span class="keyword">global</span> model</span><br><span class="line">    model.save(c.model_path)</span><br><span class="line">    print(<span class="string">f'model save -&gt; <span class="subst">&#123;c.model_path&#125;</span>'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight taggerscript"><table><tr><td class="code"><pre><span class="line">--------   模型保存    ----------</span><br><span class="line">model save -&gt; D:<span class="symbol">\g</span>itRepo<span class="symbol">\m</span>hxy<span class="symbol">\m</span>odel<span class="symbol">\m</span>hxy.h5</span><br></pre></td></tr></table></figure>

<h4 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h4><p>将以上过程组装后运行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> count():</span><br><span class="line">        data_generator()</span><br><span class="line">        model_summary()</span><br><span class="line">        model_fit()</span><br><span class="line">	model_save()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    base()</span><br><span class="line">    t(<span class="string">'结束'</span>)</span><br></pre></td></tr></table></figure>

<p>于是我们在<code>model</code>目录下生成了<code>mhxy.h5</code>模型文件</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">model</span><br><span class="line">  <span class="string">|- mhxy.h5</span></span><br></pre></td></tr></table></figure>

<h3 id="模型读取"><a href="#模型读取" class="headerlink" title="模型读取"></a>模型读取</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model_load</span><span class="params">()</span>:</span></span><br><span class="line">    t(<span class="string">'模型读取'</span>)</span><br><span class="line">    print(c.model_path)</span><br><span class="line">    <span class="keyword">global</span> model</span><br><span class="line">    model = keras.models.load_model(c.model_path)</span><br><span class="line">    model.summary()</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">--------   模型读取    ----------</span><br><span class="line"></span><br><span class="line">model\mhxy.h5</span><br><span class="line">2020-03-20 21:57:38.730370: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library nvcuda.dll</span><br><span class="line">2020-03-20 21:57:38.794436: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1555] Found device 0 with properties: </span><br><span class="line">pciBusID: 0000:03:00.0 name: GeForce GTX 1060 5GB computeCapability: 6.1</span><br><span class="line">coreClock: 1.7335GHz coreCount: 10 deviceMemorySize: 5.00GiB deviceMemoryBandwidth: 149.16GiB/s</span><br><span class="line">2020-03-20 21:57:38.796527: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudart64_101.dll</span><br><span class="line">2020-03-20 21:57:38.821242: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cublas64_10.dll</span><br><span class="line">2020-03-20 21:57:38.836458: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cufft64_10.dll</span><br><span class="line">2020-03-20 21:57:38.843690: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library curand64_10.dll</span><br><span class="line">2020-03-20 21:57:38.857073: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusolver64_10.dll</span><br><span class="line">2020-03-20 21:57:38.864317: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusparse64_10.dll</span><br><span class="line">2020-03-20 21:57:38.879320: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudnn64_7.dll</span><br><span class="line">2020-03-20 21:57:38.881830: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1697] Adding visible gpu devices: 0</span><br><span class="line">2020-03-20 21:57:38.886175: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1555] Found device 0 with properties: </span><br><span class="line">pciBusID: 0000:03:00.0 name: GeForce GTX 1060 5GB computeCapability: 6.1</span><br><span class="line">coreClock: 1.7335GHz coreCount: 10 deviceMemorySize: 5.00GiB deviceMemoryBandwidth: 149.16GiB/s</span><br><span class="line">2020-03-20 21:57:38.887320: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudart64_101.dll</span><br><span class="line">2020-03-20 21:57:38.887871: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cublas64_10.dll</span><br><span class="line">2020-03-20 21:57:38.888409: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cufft64_10.dll</span><br><span class="line">2020-03-20 21:57:38.888968: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library curand64_10.dll</span><br><span class="line">2020-03-20 21:57:38.889514: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusolver64_10.dll</span><br><span class="line">2020-03-20 21:57:38.890090: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cusparse64_10.dll</span><br><span class="line">2020-03-20 21:57:38.890651: I tensorflow/stream<span class="emphasis">_executor/platform/default/dso_</span>loader.cc:44] Successfully opened dynamic library cudnn64_7.dll</span><br><span class="line">2020-03-20 21:57:38.892737: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1697] Adding visible gpu devices: 0</span><br><span class="line">2020-03-20 21:57:39.833100: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1096] Device interconnect StreamExecutor with strength 1 edge matrix:</span><br><span class="line">2020-03-20 21:57:39.833639: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1102]      0 </span><br><span class="line">2020-03-20 21:57:39.834024: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1115] 0:   N </span><br><span class="line">2020-03-20 21:57:39.835939: I tensorflow/core/common<span class="emphasis">_runtime/gpu/gpu_</span>device.cc:1241] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3833 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1060 5GB, pci bus id: 0000:03:00.0, compute capability: 6.1)</span><br><span class="line">Model: "sequential"</span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">Layer (type)                 Output Shape              Param #   </span><br><span class="line">=================================================================</span><br><span class="line">conv2d (Conv2D)              (None, 100, 100, 16)      448       </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">max_pooling2d (MaxPooling2D) (None, 50, 50, 16)        0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">conv2d_1 (Conv2D)            (None, 50, 50, 32)        4640      </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">max<span class="emphasis">_pooling2d_</span>1 (MaxPooling2 (None, 25, 25, 32)        0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">conv2d_2 (Conv2D)            (None, 25, 25, 64)        18496     </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">max<span class="emphasis">_pooling2d_</span>2 (MaxPooling2 (None, 12, 12, 64)        0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">flatten (Flatten)            (None, 9216)              0         </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">dense (Dense)                (None, 64)                589888    </span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br><span class="line">dense_1 (Dense)              (None, 1)                 65        </span><br><span class="line">=================================================================</span><br><span class="line">Total params: 613,537</span><br><span class="line">Trainable params: 613,537</span><br><span class="line">Non-trainable params: 0</span><br><span class="line"><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span></span><br></pre></td></tr></table></figure>

<h3 id="进行预测"><a href="#进行预测" class="headerlink" title="进行预测"></a>进行预测</h3><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">def model_predict(paths):</span><br><span class="line">    t(<span class="string">'模型预测'</span>)</span><br><span class="line">    <span class="keyword">global</span> model</span><br><span class="line">    imgs = [load_and_preprocess_image(path) <span class="keyword">for</span> path <span class="keyword">in</span> paths]</span><br><span class="line">    imgs =  tf.convert_to_tensor(imgs)</span><br><span class="line">    predictions = model.predict(imgs)</span><br><span class="line">    predictions = [row[<span class="number">0</span>] <span class="keyword">for</span> row <span class="keyword">in</span> predictions]</span><br><span class="line">    min_index = predictions.index(<span class="keyword">min</span>(predictions))</span><br><span class="line">    <span class="keyword">print</span>(f<span class="string">' 预测结果为 第 &gt; &#123;min_index + 1&#125; &lt; 张图片'</span>)</span><br><span class="line">    <span class="keyword">return</span> min_index</span><br><span class="line"></span><br><span class="line">def preprocess_image(<span class="keyword">image</span>):</span><br><span class="line">  <span class="keyword">image</span> = tf.<span class="keyword">image</span>.decode_jpeg(<span class="keyword">image</span>, channels=<span class="number">3</span>)</span><br><span class="line">  <span class="keyword">image</span> = tf.<span class="keyword">image</span>.resize(<span class="keyword">image</span>, [IMG_WIDTH, IMG_HEIGHT])</span><br><span class="line">  <span class="keyword">image</span> /= <span class="number">255.0</span>  # <span class="keyword">normalize</span> to [<span class="number">0</span>,<span class="number">1</span>] range</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">image</span></span><br><span class="line"></span><br><span class="line">def load_and_preprocess_image(path):</span><br><span class="line">  <span class="keyword">image</span> = tf.io.read_file(path)</span><br><span class="line">  <span class="keyword">return</span> preprocess_image(<span class="keyword">image</span>)</span><br></pre></td></tr></table></figure>

<p><code>model.predict(imgs)</code>预测了一组照片，返回值为一组照片的<strong>可能性</strong>数组，值越<strong>小(负)</strong>越倾向于<strong>front</strong>，值越<strong>大(正)</strong>越倾向于<strong>others</strong></p>
<p>于是我们<strong>读取模型</strong>并<strong>预测</strong><a href="https://di1shuai.com/tensorflow%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%A2%A6%E5%B9%BB%E8%A5%BF%E6%B8%B8%E4%BA%BA%E7%89%A9%E5%BC%B9%E7%AA%97%E8%AF%86%E5%88%AB%EF%BC%88%E4%BA%8C%EF%BC%89.html">上一篇文章</a>已经切出来的一组照片</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">model_load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">model_predict</span><span class="params">(c.crop_4_img_paths)</span></span></span><br></pre></td></tr></table></figure>

<p><img src="http://images.di1shuai.com/FtNE-uhRJniapeoZu-L5DTnVY-KH" alt><br><img src="http://images.di1shuai.com/Fu4P4PpvjEdWYxPwiBl0bzL-Yw-u" alt><br><img src="http://images.di1shuai.com/FoRMjFWNw0ixNK6tYIwKADSQi-UX" alt><br><img src="http://images.di1shuai.com/FsGV0OkNfQuog-NtJx33JRAC-IlA" alt></p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">--------   模型预测    ----------</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">18.551882</span>: I tensorflow/stream_executor/<span class="keyword">platform</span>/<span class="keyword">default</span>/dso_loader.cc:<span class="number">44</span>] Successfully opened <span class="keyword">dynamic</span> <span class="keyword">library</span> cublas64_10.dll</span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">18.915562</span>: I tensorflow/stream_executor/<span class="keyword">platform</span>/<span class="keyword">default</span>/dso_loader.cc:<span class="number">44</span>] Successfully opened <span class="keyword">dynamic</span> <span class="keyword">library</span> cudnn64_7.dll</span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">20</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">20.185335</span>: W tensorflow/stream_executor/gpu/redzone_allocator.cc:<span class="number">312</span>] Internal: Invoking GPU <span class="keyword">asm</span> compilation <span class="keyword">is</span> supported <span class="keyword">on</span> Cuda non-Windows platforms only</span><br><span class="line">Relying <span class="keyword">on</span> driver <span class="keyword">to</span> perform ptx compilation. This <span class="keyword">message</span> will be only logged once.</span><br><span class="line">[<span class="number">11.985916</span>, <span class="number">10.617589</span>, <span class="number">1.425591</span>, -<span class="number">2.6980643</span>]</span><br><span class="line"> 预测结果为 第 &gt; <span class="number">4</span> &lt; 张图片&lt;</span><br><span class="line"></span><br><span class="line">--------   结束    ----------</span><br></pre></td></tr></table></figure>

<p><img src="http://images.di1shuai.com/FhafeoF-EUhcVGl_l_lxRrzNHytm" alt></p>
<hr>
<h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><p>到这里，我们关于<strong>预测</strong>部分的内容就已经完毕，回头看看我们走过的路<br><img src="http://images.di1shuai.com/FkislI5cz5t4U_-ezCJsHh4rTuKy" alt><br>是不是胜利在望！</p>
<hr>
<h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>本人无任何商业目的，仅用于学习和娱乐，<a href="https://github.com/BestBurning/mhxy" target="_blank" rel="noopener">源代码</a>采用了<a href="https://opensource.org/licenses/AGPL-3.0" target="_blank" rel="noopener">AGPL3.0</a>开源协议</p>
<p>本文为博主原创文章，任何人未经过博主同意不得转载</p>

      <script>
        window.disqusProxy={
          shortname: 'diyishuai',
          username: 'di1shuai',
          server: 'disqus.di1shuai.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: 'tensorflow实践：梦幻西游人物弹窗识别（三）.html',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><div class="tags"><a href="/tags/Windows/"><i class="fa fa-tag"></i>Windows</a><a href="/tags/tensorflow/"><i class="fa fa-tag"></i>tensorflow</a><a href="/tags/梦幻西游/"><i class="fa fa-tag"></i>梦幻西游</a></div><div class="post-nav"><a class="pre" href="/tensorflow实践：梦幻西游人物弹窗识别（四）.html">tensorflow实践：梦幻西游人物弹窗识别（四）</a><a class="next" href="/tensorflow实践：梦幻西游人物弹窗识别（二）.html">tensorflow实践：梦幻西游人物弹窗识别（二）</a></div>
      <script src="//cdn.bootcss.com/react/16.0.0/umd/react.production.min.js"></script>
      <script src="//cdn.bootcss.com/react-dom/16.0.0/umd/react-dom.production.min.js"></script>
      <script src="//cdn.bootcss.com/fetch/2.0.3/fetch.min.js"></script>
      <script src="//cdn.jsdelivr.net/npm/blockies-identicon@0.1.0/blockies.min.js"></script>
      <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
      <div id="disqus_proxy_thread"><script src="/scripts/hexo-disqus-proxy-primary.js" async></script><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://di1shuai.com/tensorflow实践：梦幻西游人物弹窗识别（三）.html';
    this.page.identifier = 'tensorflow实践：梦幻西游人物弹窗识别（三）.html';
    this.page.title = 'tensorflow实践：梦幻西游人物弹窗识别（三）';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//diyishuai.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//diyishuai.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://diyishuai.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://di1shuai.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/products/">products</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Flink数据转换-Transformation.html">Flink-DataStream-Transformations</a></li><li class="post-list-item"><a class="post-list-link" href="/Kubernetes架构.html">Kubernetes架构</a></li><li class="post-list-item"><a class="post-list-link" href="/使用GithubAction推送Docker到华为镜像中心.html">使用GithubAction推送Docker到香港华为镜像中心</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-compose安装单机Elasticsearch.html">docker-compose安装单机Elasticsearch</a></li><li class="post-list-item"><a class="post-list-link" href="/使用GithubAction发布Flutter项目.html">使用GithubAction发布Flutter项目-Android</a></li><li class="post-list-item"><a class="post-list-link" href="/招行积分题.html">招行积分题</a></li><li class="post-list-item"><a class="post-list-link" href="/设计模式之行为型.html">设计模式之行为型</a></li><li class="post-list-item"><a class="post-list-link" href="/Java各版本新特性.html">Java各版本新特性</a></li><li class="post-list-item"><a class="post-list-link" href="/Kafka——分区策略.html">Kafka——分区策略</a></li><li class="post-list-item"><a class="post-list-link" href="/Kafka——Rebalance过程.html">Kafka——Rebalance过程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.csdn.net/u012373815" title="Abel的博客(大数据、AI专家)" target="_blank">Abel的博客(大数据、AI专家)</a><ul></ul><a href="https://blog.csdn.net/u010416101" title="Sean的博客(大数据、AI专家)" target="_blank">Sean的博客(大数据、AI专家)</a><ul></ul><a href="https://yo-cwj.com/" title="陈文俊的博客(前端专家)" target="_blank">陈文俊的博客(前端专家)</a><ul></ul><a href="https://www.xilanhua-c7.top" title="西蓝花的博客(未知领域专家)" target="_blank">西蓝花的博客(未知领域专家)</a><ul></ul><a href="https://gaojianchao.github.io/learngit/" title="Alan的博客(AI专家)" target="_blank">Alan的博客(AI专家)</a><ul></ul><a href="https://woj.app" title="虾米的蜗居" target="_blank">虾米的蜗居</a><ul></ul><a href="https://blog.mightyherox.me" title="circlehotarux的博客" target="_blank">circlehotarux的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2016-2021 <a href="/." rel="nofollow">第一帅 </a> |&nbsp;<a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn"> 晋ICP备15004021号-1</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/love.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>