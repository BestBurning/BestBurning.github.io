<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="正走在通向编程、艺术、摄影、剪辑、写作、运动的路上的Full Stacker,Stay Cool!!!"><meta name="google-site-verification" content="q2XooBg_4_mx5-YvLlJvWzU3gxn_9nUvFpLz2_pU584"><meta name="keywords" content="tensorflow,梦幻西游,弹窗识别,python,自动点击"><title>tensorflow实践：梦幻西游人物弹窗识别（二） - 第一帅</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-163115360-1','auto');ga('send','pageview');
</script><script>(function () {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">tensorflow实践：梦幻西游人物弹窗识别（二）</h1><a id="logo" href="/.">第一帅</a><p class="description">Shea的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/products/"><i class="fa fa-cubes"> 作品</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">tensorflow实践：梦幻西游人物弹窗识别（二）</h1><div class="post-meta">2020-03-19<span> | </span><span class="category"><a href="/categories/technology/">technology</a><span>  </span></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="tensorflow实践：梦幻西游人物弹窗识别（二）.html" href="/tensorflow实践：梦幻西游人物弹窗识别（二）.html#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境描述"><span class="toc-number">1.</span> <span class="toc-text">环境描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#窗口截图"><span class="toc-number">2.</span> <span class="toc-text">窗口截图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#截图切分"><span class="toc-number">3.</span> <span class="toc-text">截图切分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#战斗状态判断"><span class="toc-number">3.1.</span> <span class="toc-text">战斗状态判断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#判断是否弹窗"><span class="toc-number">3.2.</span> <span class="toc-text">判断是否弹窗</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#切出包含4个人物的大图"><span class="toc-number">3.3.</span> <span class="toc-text">切出包含4个人物的大图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#再切出单个人物"><span class="toc-number">3.4.</span> <span class="toc-text">再切出单个人物</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#组合"><span class="toc-number">4.</span> <span class="toc-text">组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回顾"><span class="toc-number">5.</span> <span class="toc-text">回顾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#声明"><span class="toc-number">6.</span> <span class="toc-text">声明</span></a></li></ol></div></div><div class="post-content"><p>由<a href="https://di1shuai.com/tensorflow%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%A2%A6%E5%B9%BB%E8%A5%BF%E6%B8%B8%E4%BA%BA%E7%89%A9%E5%BC%B9%E7%AA%97%E8%AF%86%E5%88%AB%EF%BC%88%E4%B8%80%EF%BC%89.html">上一篇</a>的思路我们可以定义以下的具体实现步骤<br><img src="http://images.di1shuai.com/FkMKDBPbKXGq3ubgfeTzt2Vtcp-N" alt></p>
<p>本篇将围绕<strong>窗口捕获、屏幕截图、截图切分</strong>讲述<a href="https://github.com/BestBurning/mhxy/blob/master/screen.py" target="_blank" rel="noopener">screen.py</a>代码</p>
<h3 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h3><p><a href="https://www.microsoft.com/zh-cn/software-download/windows10" target="_blank" rel="noopener">Windows</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">C:\Users\SF&gt;ver</span></span><br><span class="line"><span class="string">Microsoft</span> <span class="string">Windows</span> <span class="string">[版本</span> <span class="number">10.0</span><span class="number">.18363</span><span class="number">.720</span><span class="string">]</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.python.org/downloads/" target="_blank" rel="noopener">Python</a></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">C</span>:\<span class="selector-tag">Users</span>\<span class="selector-tag">SF</span>&gt;<span class="selector-tag">python</span> <span class="selector-tag">--version</span></span><br><span class="line"><span class="selector-tag">Python</span> 3<span class="selector-class">.7</span><span class="selector-class">.6</span></span><br></pre></td></tr></table></figure>

<p><a href="http://xyq.163.com/download/index.html?=xyqload" target="_blank" rel="noopener">梦幻西游</a></p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">启动方式   多标签版</span><br><span class="line">分辨率     <span class="number">800x600</span></span><br><span class="line">界面风格   暖风</span><br></pre></td></tr></table></figure>

<p><img src="http://images.di1shuai.com/FkW3mC0_6XGmeMxLdvqkxMGfcORg" alt><br><img src="http://images.di1shuai.com/FtjEhCyk52bg347Wsn0hAre_GiZL" alt></p>
<h3 id="窗口截图"><a href="#窗口截图" class="headerlink" title="窗口截图"></a>窗口截图</h3><p>主要是使用了<code>PyQt5</code>进行截图</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">hwnd_title = dict()</span><br><span class="line"></span><br><span class="line">def get_all_hwnd(hwnd,mouse):</span><br><span class="line">    <span class="keyword">if</span> win32gui.IsWindow(hwnd) <span class="keyword">and</span> win32gui.IsWindowEnabled(hwnd) <span class="keyword">and</span> win32gui.IsWindowVisible(hwnd):</span><br><span class="line">        hwnd_title.update(&#123;hwnd:win32gui.GetWindowText(hwnd)&#125;)</span><br><span class="line"></span><br><span class="line">def shot():</span><br><span class="line">    win32gui.EnumWindows(get_all_hwnd, 0)</span><br><span class="line">    mhxy_title = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> h,t <span class="keyword">in</span> hwnd_title.items():</span><br><span class="line">        <span class="keyword">if</span> t.startswith(<span class="string">'梦幻西游 ONLINE'</span>):</span><br><span class="line">            mhxy_title = t</span><br><span class="line">            <span class="builtin-name">print</span>(mhxy_title)</span><br><span class="line">            hwnd = win32gui.FindWindow(None, mhxy_title)</span><br><span class="line">            app = QApplication(sys.argv)</span><br><span class="line">            desktop_id = app.desktop().winId()</span><br><span class="line">           <span class="built_in"> screen </span>= QApplication.primaryScreen()</span><br><span class="line">            img_desk = screen.grabWindow(desktop_id).toImage()</span><br><span class="line">            img_sc = screen.grabWindow(hwnd).toImage()</span><br><span class="line">            img_desk.save(img_desktop_path)</span><br><span class="line">            img_sc.save(img_sc_path)</span><br><span class="line">            <span class="builtin-name">print</span>(f<span class="string">'img_desktop save to -&gt; &#123;os.path.abspath(img_desktop_path)&#125;'</span>)</span><br><span class="line">            <span class="builtin-name">print</span>(f<span class="string">'img_mhxy save to -&gt; &#123;os.path.abspath(img_sc_path)&#125;'</span>)</span><br><span class="line">    <span class="keyword">if</span> mhxy_title == <span class="string">''</span>:</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">'mhxy not start'</span>)</span><br><span class="line">        return <span class="literal">False</span></span><br><span class="line">    return <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>于是我们在路径</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- desktop.jpg</span></span><br><span class="line">  <span class="string">|- mhxy.jpg</span></span><br></pre></td></tr></table></figure>

<p>得到一张<strong>全屏</strong>截图以及一张梦幻的<strong>窗口</strong>截图</p>
<h3 id="截图切分"><a href="#截图切分" class="headerlink" title="截图切分"></a>截图切分</h3><p>得到屏幕截图后，我们将对截图进行切分<br><img src="http://images.di1shuai.com/FuRjXMN4Cgpm9rGJe-patSpt18d6" alt></p>
<h4 id="战斗状态判断"><a href="#战斗状态判断" class="headerlink" title="战斗状态判断"></a>战斗状态判断</h4><p>因为进入<strong>战斗</strong>才会弹窗，所以首先对战斗状态进行判断<br>战斗状态的判断是依据了梦幻窗口最右侧<strong>战斗标识</strong>，不同的界面风格标识的颜色是<strong>不同</strong>的，我用的是<strong>暖风</strong>界面风格<br><img src="http://images.di1shuai.com/Fg8Btk_CGNzOxFuoZ25BCgI4Nrbg" alt><br><img src="http://images.di1shuai.com/FpwXJGD-ZAVQWmpJQCXpC55eU8t6" alt><br>战斗标识路径</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- flag</span></span><br><span class="line">      <span class="string">|- fighting_flag.jpg</span></span><br></pre></td></tr></table></figure>

<p>截取相同区域的图片使用<code>opencv</code>与战斗标识进行<strong>相似性判断</strong>，如果相似度大于<code>%95</code>则判定为<strong>战斗状态</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 战斗截图</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fight_crop</span><span class="params">()</span>:</span></span><br><span class="line">    util.log_title(<span class="string">'战斗标识截图'</span>)</span><br><span class="line">    <span class="keyword">return</span> crop(c.img_sc_path,c.fighting_img_path,c.fight_shape)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否在战斗</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_fight</span><span class="params">()</span>:</span></span><br><span class="line">    util.log_title(<span class="string">'状态判断'</span>)</span><br><span class="line">    rate = compare_image(c.fighting_flag_img_path,c.fighting_img_path)</span><br><span class="line">    <span class="keyword">if</span> rate &gt; <span class="number">0.95</span>:</span><br><span class="line">        print(<span class="string">'战斗 状态'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'非战斗 状态'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 相似性判断</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_image</span><span class="params">(path_image1, path_image2)</span>:</span></span><br><span class="line"></span><br><span class="line">    imageA = cv.imread(path_image1)</span><br><span class="line">    imageB = cv.imread(path_image2)</span><br><span class="line">    grayA = cv.cvtColor(imageA, cv.COLOR_BGR2GRAY)</span><br><span class="line">    grayB = cv.cvtColor(imageB, cv.COLOR_BGR2GRAY)</span><br><span class="line"></span><br><span class="line">    (score, diff) = structural_similarity(grayA, grayB, full=<span class="literal">True</span>)</span><br><span class="line">    print(<span class="string">"SSIM: &#123;&#125;"</span>.format(score))</span><br><span class="line">    <span class="keyword">return</span> score</span><br><span class="line"></span><br><span class="line"><span class="comment"># 裁剪</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crop</span><span class="params">(source_path,target_path,shape)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> Image.open(source_path) <span class="keyword">as</span> img:</span><br><span class="line"></span><br><span class="line">        fighting_flag_img = img.crop(shape)</span><br><span class="line">        fighting_flag_img.save(target_path)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>截取战斗标识相同区域的路径为</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- sub</span></span><br><span class="line">      <span class="string">|- fighting.jpg</span></span><br></pre></td></tr></table></figure>

<h4 id="判断是否弹窗"><a href="#判断是否弹窗" class="headerlink" title="判断是否弹窗"></a>判断是否弹窗</h4><p>接下来我们开始判断是否<strong>弹窗</strong>，目前见到的弹窗形式有<strong>两种</strong>,可以使用如下两种弹窗标识去匹配梦幻窗口<br><img src="http://images.di1shuai.com/FsDnEA61Ur_uV62uxbL4gQYtpeBs" alt><br><img src="http://images.di1shuai.com/FoD8Po6Zuh31WkOSZ9_QEl-52S8P" alt></p>
<p>所以弹窗判断的思路如下<br><img src="http://images.di1shuai.com/Fh4cAxJOIYd09wqsTIWPV9-q4MKv" alt></p>
<p>使用 <a href="https://docs.opencv.org/4.2.0/d4/dc6/tutorial_py_template_matching.html" target="_blank" rel="noopener">OpenCV Template Matching</a> 对梦幻窗口进行匹配，并返回<strong>最匹配</strong>(<strong>得分最高</strong>)的区域</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">def popup_sub_crop():</span><br><span class="line">    util.log_title(<span class="string">'弹窗判断'</span>)</span><br><span class="line">    shape_dict = &#123;&#125; </span><br><span class="line">    for i in range(len(c.popup_flag_img_paths)):</span><br><span class="line">        shape,score = template_match(c.popup_flag_img_paths[i],c.img_sc_path)</span><br><span class="line">        shape_dict[shape] = (score,i)</span><br><span class="line">    </span><br><span class="line">    print(shape_dict)</span><br><span class="line">    max_shape = max(shape_dict, key=shape_dict.get)</span><br><span class="line">    score,i = shape_dict[max_shape]</span><br><span class="line">    print(f<span class="string">'最大区域 &#123;max_shape&#125; 最终得分为 &#123;score&#125;'</span> )</span><br><span class="line">    if score &gt;=<span class="number">3</span> :</span><br><span class="line">        sub_shape = (</span><br><span class="line">            max_shape[<span class="number">0</span>]+c.popup_move_shapes[i][<span class="number">0</span>],</span><br><span class="line">            max_shape[<span class="number">1</span>]+c.popup_move_shapes[i][<span class="number">1</span>],</span><br><span class="line">            max_shape[<span class="number">2</span>]+c.popup_move_shapes[i][<span class="number">2</span>],</span><br><span class="line">            max_shape[<span class="number">3</span>]+c.popup_move_shapes[i][<span class="number">3</span>]</span><br><span class="line">        )</span><br><span class="line">        print(f<span class="string">'弹框区域  &#123;sub_shape&#125;'</span>)</span><br><span class="line">        return crop(c.img_sc_path,c.popup_sub_img_path,sub_shape)</span><br><span class="line">    print(f<span class="string">'没有弹框'</span>)</span><br><span class="line">    return <span class="symbol">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def template_match(template_path,src_path):</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    img = cv.imread(src_path,<span class="number">0</span>)</span><br><span class="line">    img2 = img.copy()</span><br><span class="line">    template = cv.imread(template_path,<span class="number">0</span>)</span><br><span class="line">    w, h = template.shape[::-<span class="number">1</span>]</span><br><span class="line">    methods = [<span class="string">'cv.TM_CCOEFF'</span>, <span class="string">'cv.TM_CCOEFF_NORMED'</span>,<span class="string">'cv.TM_CCORR'</span>,</span><br><span class="line">                <span class="string">'cv.TM_CCORR_NORMED'</span>, <span class="string">'cv.TM_SQDIFF'</span>, <span class="string">'cv.TM_SQDIFF_NORMED'</span>]</span><br><span class="line">    shape_dict = &#123;&#125;</span><br><span class="line">    for meth in methods:</span><br><span class="line">        img = img2.copy()</span><br><span class="line">        method = eval(meth)</span><br><span class="line">        # <span class="symbol">Apply</span> template <span class="symbol">Matching</span></span><br><span class="line">        res = cv.matchTemplate(img,template,method)</span><br><span class="line">        min_val, max_val, min_loc, max_loc = cv.minMaxLoc(res)</span><br><span class="line">        if method in [cv.<span class="symbol">TM_SQDIFF</span>, cv.<span class="symbol">TM_SQDIFF_NORMED</span>]:</span><br><span class="line">            top_left = min_loc</span><br><span class="line">        else:</span><br><span class="line">            top_left = max_loc</span><br><span class="line">        bottom_right = (top_left[<span class="number">0</span>] + w, top_left[<span class="number">1</span>] + h)  </span><br><span class="line">        # cv.rectangle(img,top_left, bottom_right, <span class="number">255</span>, <span class="number">2</span>)</span><br><span class="line">        # plt.subplot(<span class="number">121</span>),plt.imshow(res,cmap = <span class="string">'gray'</span>)</span><br><span class="line">        # plt.title(<span class="string">'Matching Result'</span>), plt.xticks([]), plt.yticks([])</span><br><span class="line">        # plt.subplot(<span class="number">122</span>),plt.imshow(img,cmap = <span class="string">'gray'</span>)</span><br><span class="line">        # plt.title(<span class="string">'Detected Point'</span>), plt.xticks([]), plt.yticks([])</span><br><span class="line">        # plt.suptitle(meth)</span><br><span class="line">        # plt.show()</span><br><span class="line">        shape = (top_left[<span class="number">0</span>],top_left[<span class="number">1</span>],bottom_right[<span class="number">0</span>],bottom_right[<span class="number">1</span>])</span><br><span class="line">        # print(shape)</span><br><span class="line">        if shape_dict.get(shape) == <span class="symbol">None</span>:</span><br><span class="line">            shape_dict[shape] = <span class="number">1</span>;</span><br><span class="line">        else:</span><br><span class="line">            shape_dict[shape] = shape_dict[shape]+<span class="number">1</span>        </span><br><span class="line">        max_shape = max(shape_dict, key=shape_dict.get)</span><br><span class="line">    return max_shape,shape_dict[max_shape]</span><br></pre></td></tr></table></figure>

<h4 id="切出包含4个人物的大图"><a href="#切出包含4个人物的大图" class="headerlink" title="切出包含4个人物的大图"></a>切出包含4个人物的大图</h4><p>这个包含四个人物的图片宽高为<code>360 x 120</code><br><img src="http://images.di1shuai.com/FvmxSuj1rzrJwWLb5v2ZMK5yqqYg" alt></p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">def popup_sub_crop():</span><br><span class="line">    util.log_title(<span class="string">'弹窗判断'</span>)</span><br><span class="line">    shape_dict = &#123;&#125; </span><br><span class="line">    for i in range(len(c.popup_flag_img_paths)):</span><br><span class="line">        shape,score = template_match(c.popup_flag_img_paths[i],c.img_sc_path)</span><br><span class="line">        shape_dict[shape] = (score,i)</span><br><span class="line">    </span><br><span class="line">    print(shape_dict)</span><br><span class="line">    max_shape = max(shape_dict, key=shape_dict.get)</span><br><span class="line">    score,i = shape_dict[max_shape]</span><br><span class="line">    print(f<span class="string">'最大区域 &#123;max_shape&#125; 最终得分为 &#123;score&#125;'</span> )</span><br><span class="line">    if score &gt;=<span class="number">3</span> :</span><br><span class="line">        sub_shape = (</span><br><span class="line">            max_shape[<span class="number">0</span>]+c.popup_move_shapes[i][<span class="number">0</span>],</span><br><span class="line">            max_shape[<span class="number">1</span>]+c.popup_move_shapes[i][<span class="number">1</span>],</span><br><span class="line">            max_shape[<span class="number">2</span>]+c.popup_move_shapes[i][<span class="number">2</span>],</span><br><span class="line">            max_shape[<span class="number">3</span>]+c.popup_move_shapes[i][<span class="number">3</span>]</span><br><span class="line">        )</span><br><span class="line">        print(f<span class="string">'弹框区域  &#123;sub_shape&#125;'</span>)</span><br><span class="line">        return crop(c.img_sc_path,c.popup_sub_img_path,sub_shape)</span><br><span class="line">    print(f<span class="string">'没有弹框'</span>)</span><br><span class="line">    return <span class="symbol">False</span></span><br></pre></td></tr></table></figure>

<p>路径如下</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- sub</span></span><br><span class="line">      <span class="string">|- pop_sub.jpg</span></span><br></pre></td></tr></table></figure>

<h4 id="再切出单个人物"><a href="#再切出单个人物" class="headerlink" title="再切出单个人物"></a>再切出单个人物</h4><p>单个人物宽高为<code>90 x 120</code><br><img src="http://images.di1shuai.com/FtNE-uhRJniapeoZu-L5DTnVY-KH" alt></p>
<figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line">def crop_4():</span><br><span class="line">    util.log_title(<span class="string">'弹窗人物切分'</span>)</span><br><span class="line">    w = <span class="number">90</span></span><br><span class="line">    h = <span class="number">120</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">i</span> in range(len(c.crop_4_img_names)):</span><br><span class="line">        shape = (w*<span class="built_in">i</span>, <span class="number">0</span>, w*(<span class="built_in">i</span>+<span class="number">1</span>), h)</span><br><span class="line">        crop(c.popup_sub_img_path,c.crop_4_img_paths[<span class="built_in">i</span>],shape)</span><br></pre></td></tr></table></figure>

<p>路径如下</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">images</span><br><span class="line">  <span class="string">|- sub</span></span><br><span class="line">      <span class="string">|- 1.jpg</span></span><br><span class="line">      <span class="string">|- 2.jpg  </span></span><br><span class="line">      <span class="string">|- 3.jpg</span></span><br><span class="line">      <span class="string">|- 4.jpg</span></span><br></pre></td></tr></table></figure>

<h3 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h3><p>于是我们将以上步骤组合起来</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">def task():</span><br><span class="line"></span><br><span class="line">    print()</span><br><span class="line">    <span class="keyword">if</span> shot():                                                          ## 截图</span><br><span class="line">        <span class="keyword">if</span> image_check(c.img_sc_path,c.screen_size):                    ## 检查截图大小</span><br><span class="line">            fight_crop()                                                ## 战斗标识截图</span><br><span class="line">            <span class="keyword">if</span> is_fight():                                              ## 判断是否在战斗</span><br><span class="line">                <span class="keyword">if</span> popup_sub_crop():                                    ## 弹窗识别 与 人物区域切出</span><br><span class="line">                    <span class="keyword">if</span> image_check(c.popup_sub_img_path,c.sub_size):    ## 弹窗人物截图检查</span><br><span class="line">                        crop_4()                                        ## 弹窗人物切分                   </span><br><span class="line">                        print()</span><br><span class="line">                        return <span class="literal">True</span></span><br><span class="line">    return <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    task()</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">--------</span>   <span class="string">截图</span>    <span class="string">----------</span></span><br><span class="line"></span><br><span class="line"><span class="string">梦幻西游</span> <span class="string">ONLINE</span> <span class="bullet">-</span> <span class="string">(xxxxxxx</span> <span class="bullet">-</span> <span class="string">xxxxx[xxxxx])</span></span><br><span class="line"><span class="string">img_desktop</span> <span class="string">save</span> <span class="string">to</span> <span class="string">-&gt;</span> <span class="string">d:\gitRepo\mhxy\images\desktop.jpg</span></span><br><span class="line"><span class="string">img_mhxy</span> <span class="string">save</span> <span class="string">to</span> <span class="string">-&gt;</span> <span class="string">d:\gitRepo\mhxy\images\mhxy.jpg</span></span><br><span class="line"></span><br><span class="line"><span class="string">--------</span>   <span class="string">截图检查</span>    <span class="string">----------</span></span><br><span class="line"></span><br><span class="line">        <span class="string">size=(812,</span> <span class="number">663</span><span class="string">)</span>     <span class="string">ok</span></span><br><span class="line"></span><br><span class="line"><span class="string">--------</span>   <span class="string">战斗标识截图</span>    <span class="string">----------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">--------</span>   <span class="string">状态判断</span>    <span class="string">----------</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SSIM:</span> <span class="number">0.9955642623257255</span></span><br><span class="line"><span class="string">战斗</span> <span class="string">状态</span></span><br><span class="line"></span><br><span class="line"><span class="string">--------</span>   <span class="string">弹窗判断</span>    <span class="string">----------</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;(277,</span> <span class="number">221</span><span class="string">,</span> <span class="number">457</span><span class="string">,</span> <span class="number">234</span><span class="string">):</span> <span class="string">(1,</span> <span class="number">0</span><span class="string">),</span> <span class="string">(334,</span> <span class="number">223</span><span class="string">,</span> <span class="number">430</span><span class="string">,</span> <span class="number">237</span><span class="string">):</span> <span class="string">(4,</span> <span class="number">1</span><span class="string">)&#125;</span></span><br><span class="line"><span class="string">最大区域</span> <span class="string">(334,</span> <span class="number">223</span><span class="string">,</span> <span class="number">430</span><span class="string">,</span> <span class="number">237</span><span class="string">)</span> <span class="string">最终得分为</span> <span class="number">4</span></span><br><span class="line"><span class="string">弹框区域</span>  <span class="string">(252,</span> <span class="number">252</span><span class="string">,</span> <span class="number">612</span><span class="string">,</span> <span class="number">372</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="string">--------</span>   <span class="string">截图检查</span>    <span class="string">----------</span></span><br><span class="line"></span><br><span class="line">        <span class="string">size=(360,</span> <span class="number">120</span><span class="string">)</span>     <span class="string">ok</span></span><br><span class="line"></span><br><span class="line"><span class="string">--------</span>   <span class="string">弹窗人物切分</span>    <span class="string">----------</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><p>到这里，<strong>窗口捕获、屏幕截图、截图切分</strong>部分就已经完毕，我们再来看一下进度<br><img src="http://images.di1shuai.com/FtKWasG4kAAin4mpYZvkkLu8Ohsl" alt><br>是不是胜利指日可待！</p>
<hr>
<h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>本人无任何商业目的，仅用于学习和娱乐，<a href="https://github.com/BestBurning/mhxy" target="_blank" rel="noopener">源代码</a>采用了<a href="https://opensource.org/licenses/AGPL-3.0" target="_blank" rel="noopener">AGPL3.0</a>开源协议</p>
<p>本文为博主原创文章，任何人未经过博主同意不得转载</p>

      <script>
        window.disqusProxy={
          shortname: 'diyishuai',
          username: 'di1shuai',
          server: 'disqus.di1shuai.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: 'tensorflow实践：梦幻西游人物弹窗识别（二）.html',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><div class="tags"><a href="/tags/Windows/"><i class="fa fa-tag"></i>Windows</a><a href="/tags/tensorflow/"><i class="fa fa-tag"></i>tensorflow</a><a href="/tags/梦幻西游/"><i class="fa fa-tag"></i>梦幻西游</a></div><div class="post-nav"><a class="pre" href="/tensorflow实践：梦幻西游人物弹窗识别（三）.html">tensorflow实践：梦幻西游人物弹窗识别（三）</a><a class="next" href="/tensorflow实践：梦幻西游人物弹窗识别（一）.html">tensorflow实践：梦幻西游人物弹窗识别（一）</a></div>
      <script src="//cdn.bootcss.com/react/16.0.0/umd/react.production.min.js"></script>
      <script src="//cdn.bootcss.com/react-dom/16.0.0/umd/react-dom.production.min.js"></script>
      <script src="//cdn.bootcss.com/fetch/2.0.3/fetch.min.js"></script>
      <script src="//cdn.jsdelivr.net/npm/blockies-identicon@0.1.0/blockies.min.js"></script>
      <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
      <div id="disqus_proxy_thread"><script src="/scripts/hexo-disqus-proxy-primary.js" async></script><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://di1shuai.com/tensorflow实践：梦幻西游人物弹窗识别（二）.html';
    this.page.identifier = 'tensorflow实践：梦幻西游人物弹窗识别（二）.html';
    this.page.title = 'tensorflow实践：梦幻西游人物弹窗识别（二）';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//diyishuai.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//diyishuai.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://diyishuai.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://di1shuai.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/products/">products</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Flink数据转换-Transformation.html">Flink-DataStream-Transformations</a></li><li class="post-list-item"><a class="post-list-link" href="/Kubernetes架构.html">Kubernetes架构</a></li><li class="post-list-item"><a class="post-list-link" href="/使用GithubAction推送Docker到华为镜像中心.html">使用GithubAction推送Docker到香港华为镜像中心</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-compose安装单机Elasticsearch.html">docker-compose安装单机Elasticsearch</a></li><li class="post-list-item"><a class="post-list-link" href="/使用GithubAction发布Flutter项目.html">使用GithubAction发布Flutter项目-Android</a></li><li class="post-list-item"><a class="post-list-link" href="/招行积分题.html">招行积分题</a></li><li class="post-list-item"><a class="post-list-link" href="/设计模式之行为型.html">设计模式之行为型</a></li><li class="post-list-item"><a class="post-list-link" href="/Java各版本新特性.html">Java各版本新特性</a></li><li class="post-list-item"><a class="post-list-link" href="/Kafka——分区策略.html">Kafka——分区策略</a></li><li class="post-list-item"><a class="post-list-link" href="/Kafka——Rebalance过程.html">Kafka——Rebalance过程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.csdn.net/u012373815" title="Abel的博客(大数据、AI专家)" target="_blank">Abel的博客(大数据、AI专家)</a><ul></ul><a href="https://blog.csdn.net/u010416101" title="Sean的博客(大数据、AI专家)" target="_blank">Sean的博客(大数据、AI专家)</a><ul></ul><a href="https://yo-cwj.com/" title="陈文俊的博客(前端专家)" target="_blank">陈文俊的博客(前端专家)</a><ul></ul><a href="https://www.xilanhua-c7.top" title="西蓝花的博客(未知领域专家)" target="_blank">西蓝花的博客(未知领域专家)</a><ul></ul><a href="https://gaojianchao.github.io/learngit/" title="Alan的博客(AI专家)" target="_blank">Alan的博客(AI专家)</a><ul></ul><a href="https://woj.app" title="虾米的蜗居" target="_blank">虾米的蜗居</a><ul></ul><a href="https://blog.mightyherox.me" title="circlehotarux的博客" target="_blank">circlehotarux的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2016-2021 <a href="/." rel="nofollow">第一帅 </a> |&nbsp;<a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn"> 晋ICP备15004021号-1</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/love.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>